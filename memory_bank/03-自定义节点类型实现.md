# 自定义节点类型实现

## 节点类型概述

项目实现了三种自定义节点类型，每种都有特定的功能和交互方式。所有节点都通过 G6.registerNode() 方法注册。

## 1. 矩形节点 (rectangleNode.js)

### 基本信息
- **节点类型**: `'rectangle-node'`
- **默认节点**: 是（在 config.js 中设置为默认）
- **特殊功能**: 支持子图功能

### 核心方法实现

#### draw 方法
```javascript
draw(cfg, group) {
  const size = cfg.size || [200, 100];
  const width = size[0];
  const height = size[1];
  
  // 检测是否有子图内容
  const hasSubgraphContent = this.hasSubgraphContent(cfg);
  
  // 主矩形背景
  const mainRect = group.addShape('rect', {
    attrs: {
      x: -width/2,
      y: -height/2,
      width: width,
      height: height,
      fill: cfg.style?.fill || '#fff',
      stroke: cfg.style?.stroke || '#333',
      lineWidth: cfg.style?.lineWidth || 1.5,
      radius: cfg.style?.radius || 8,
    },
    name: 'main-rect',
  });
  
  // 如果有子图内容，添加双线边框效果
  if (hasSubgraphContent) {
    // 创建内边框和外边框
  }
  
  return mainRect;
}
```

#### 双线边框效果
当节点包含子图内容时，会显示双线边框：
- **外边框**: 位置偏移-2px，线宽2px
- **内边框**: 位置偏移+3px，线宽1px
- **视觉效果**: 表示该节点包含子图内容

#### hasSubgraphContent 方法
```javascript
hasSubgraphContent(cfg) {
  if (!cfg.subGraph) return false;
  
  const subGraph = cfg.subGraph;
  
  // 检查子图中是否有节点或边
  if (subGraph.nodes && subGraph.nodes.length > 0) return true;
  if (subGraph.edges && subGraph.edges.length > 0) return true;
  
  return false;
}
```

#### setState 方法
```javascript
setState(name, value, node) {
  if (name === 'selected') {
    const group = node.getContainer();
    const shapes = ['main-rect', 'inner-border', 'outer-border'];
    
    shapes.forEach(shapeName => {
      const shape = group.find(e => e.get('name') === shapeName);
      if (shape) {
        if (value) {
          // 选中状态：添加阴影效果
          shape.attr({
            shadowColor: '#333',
            shadowBlur: 10,
          });
        } else {
          // 取消选中：移除阴影
          shape.attr({
            shadowColor: null,
            shadowBlur: 0,
          });
        }
      }
    });
  }
}
```

## 2. 文本节点 (textNode.js)

### 基本信息
- **节点类型**: `'text-only'`
- **特点**: 纯文本显示，无背景矩形
- **用途**: 标签、注释等纯文本内容

### 核心方法实现

#### draw 方法
```javascript
draw(cfg, group) {
  const style = cfg.labelCfg?.style || {};
  
  // 添加文本形状
  const textShape = group.addShape('text', {
    attrs: {
      text: cfg.label || 'Text',
      x: 0,
      y: 0,
      textAlign: 'center',
      textBaseline: 'middle',
      fill: style.fill || colors.black,
      fontSize: style.fontSize || styleConfig.fontSize.medium,
      fontFamily: 'Arial',
    },
    name: 'text-shape',
  });
  
  // 添加透明背景矩形（用于选中效果）
  const textBox = textShape.getBBox();
  const padding = sizes.padding.medium;
  
  const backgroundRect = group.addShape('rect', {
    attrs: {
      x: textBox.x - padding,
      y: textBox.y - padding,
      width: textBox.width + (padding * 2),
      height: textBox.height + (padding * 2),
      fill: 'transparent',
      stroke: 'transparent',
      radius: styleConfig.borderRadius,
    },
    name: 'text-bg',
  });
  
  backgroundRect.toBack(); // 将背景置于文本后面
  return textShape;
}
```

#### update 方法
```javascript
update(cfg, node) {
  const group = node.getContainer();
  const textShape = group.find(e => e.get('name') === 'text-shape');
  const backgroundRect = group.find(e => e.get('name') === 'text-bg');
  
  if (textShape) {
    // 更新文本属性
    textShape.attr({
      text: cfg.label,
      fill: style.fill || colors.black,
      fontSize: style.fontSize || styleConfig.fontSize.medium
    });
  }
  
  if (backgroundRect) {
    // 重新计算背景矩形尺寸
    const textBox = textShape.getBBox();
    const padding = sizes.padding.medium;
    backgroundRect.attr({
      x: textBox.x - padding,
      y: textBox.y - padding,
      width: textBox.width + (padding * 2),
      height: textBox.height + (padding * 2),
    });
  }
}
```

#### setState 方法
```javascript
setState(name, value, node) {
  if (name === 'selected') {
    const group = node.getContainer();
    const backgroundRect = group.find(e => e.get('name') === 'text-bg');
    
    if (value) {
      // 选中状态：显示蓝色边框
      backgroundRect.attr({
        stroke: colors.primary,
        shadowColor: colors.primary,
        shadowBlur: styleConfig.shadowBlur,
      });
    } else {
      // 取消选中：隐藏边框
      backgroundRect.attr({
        stroke: 'transparent',
        shadowColor: null,
        shadowBlur: 0,
      });
    }
  }
}
```

## 3. 图片节点 (imageNode.js)

### 基本信息
- **节点类型**: `'image-node'`
- **特点**: 显示图片，支持调整大小
- **控制点**: 四角控制点用于调整尺寸

### 核心方法实现

#### draw 方法
```javascript
draw(cfg, group) {
  const size = cfg.size || [100, 100];
  const width = size[0];
  const height = size[1];
  
  // 添加图片形状
  const imageShape = group.addShape('image', {
    attrs: {
      x: -width/2,
      y: -height/2,
      width: width,
      height: height,
      img: cfg.img,
    },
    name: 'image-shape',
  });

  // 添加选择边框（初始不可见）
  const borderShape = group.addShape('rect', {
    attrs: {
      x: -width/2,
      y: -height/2,
      width: width,
      height: height,
      stroke: 'transparent',
      lineWidth: 2,
    },
    name: 'image-border',
  });

  // 添加四角控制点
  const controlPoints = [
    { x: -width/2, y: -height/2, cursor: 'nw-resize', name: 'nw' },
    { x: width/2, y: -height/2, cursor: 'ne-resize', name: 'ne' },
    { x: width/2, y: height/2, cursor: 'se-resize', name: 'se' },
    { x: -width/2, y: height/2, cursor: 'sw-resize', name: 'sw' }
  ];

  controlPoints.forEach(point => {
    group.addShape('rect', {
      attrs: {
        x: point.x - controlSize/2,
        y: point.y - controlSize/2,
        width: controlSize,
        height: controlSize,
        fill: '#fff',
        stroke: colors.primary,
        cursor: point.cursor,
        opacity: 0, // 初始隐藏
      },
      name: `control-point-${point.name}`,
    });
  });

  return imageShape;
}
```

#### 控制点命名规范
- **命名格式**: `control-point-{position}`
- **位置标识**: 
  - `nw` - 左上角
  - `ne` - 右上角
  - `se` - 右下角
  - `sw` - 左下角

#### setState 方法
```javascript
setState(name, value, node) {
  if (name === 'selected') {
    const group = node.getContainer();
    const borderShape = group.find(e => e.get('name') === 'image-border');
    
    // 显示/隐藏边框
    borderShape.attr('stroke', value ? colors.primary : 'transparent');
    
    // 显示/隐藏控制点
    ['nw', 'ne', 'se', 'sw'].forEach(pos => {
      const control = group.find(e => e.get('name') === `control-point-${pos}`);
      if (control) {
        control.attr('opacity', value ? 1 : 0);
      }
    });
  }
}
```

## 节点注册流程

在 `src/index.js` 中的注册顺序：
```javascript
// 注册自定义节点
registerImageNode(G6);
registerTextNode(G6);
registerRectangleNode(G6);
```

## 节点交互特性对比

| 特性 | 矩形节点 | 文本节点 | 图片节点 |
|------|----------|----------|----------|
| 双击行为 | 进入子图 | 编辑文本 | 图片预览 |
| 选中效果 | 阴影边框 | 蓝色边框 | 蓝色边框+控制点 |
| 调整大小 | 不支持 | 不支持 | 四角控制点 |
| 右键菜单 | 支持 | 支持 | 不支持 |
| 子图功能 | 支持 | 不支持 | 不支持 |
| 文本编辑 | 支持 | 支持 | 不支持 |

## 样式配置

节点样式主要通过 `src/config.js` 进行配置：
- **defaultNode**: 默认节点样式
- **nodeStateStyles**: 节点状态样式
- **colors**: 颜色配置
- **sizes**: 尺寸配置
