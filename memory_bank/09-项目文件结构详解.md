# 项目文件结构详解

## 项目结构概览

```
d:\wza\coding\frontend\chart\
├── index.html                 # 入口HTML文件
├── package.json              # 项目配置和依赖
├── package-lock.json         # 依赖锁定文件
├── vite.config.js           # Vite构建配置
├── readme.md                # 项目说明文档
├── memory_bank/             # 文档存储目录
└── src/                     # 源代码目录
    ├── index.js             # 应用入口文件
    ├── config.js            # 全局配置文件
    ├── components/          # React组件
    ├── events/              # 事件处理模块
    ├── nodes/               # 自定义节点类型
    ├── io/                  # 文件管理模块
    ├── toolbar/             # 工具栏模块
    ├── navigation/          # 导航系统模块
    ├── contextMenu/         # 右键菜单模块
    ├── search/              # 节点搜索模块
    └── styles/              # 样式文件
```

## 1. 根目录文件

### index.html
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Diagram Editor</title>
</head>
<body>
    <div id="container"></div>
    <script type="module" src="/src/index.js"></script>
</body>
</html>
```

**关键要素**:
- `#container`: G6图形容器，应用的主要渲染区域
- ES模块加载: `type="module"` 支持现代模块语法
- 简洁结构: 只包含必要的容器元素

### package.json
```json
{
  "name": "chart",
  "version": "1.0.0",
  "description": "Module Diagram Editor",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build", 
    "preview": "vite preview"
  },
  "dependencies": {
    "@antv/g6": "^4.8.24",
    "antd": "^5.27.4", 
    "react": "^19.1.1",
    "react-dom": "^19.1.1"
  },
  "devDependencies": {
    "vite": "^5.0.0"
  }
}
```

**依赖说明**:
- **@antv/g6**: 图形可视化核心引擎
- **react + react-dom**: 用于图片预览组件
- **antd**: Ant Design UI组件库
- **vite**: 现代化构建工具

### vite.config.js
Vite构建配置文件，处理模块打包、开发服务器等功能。

### readme.md
项目详细说明文档，包含功能介绍、使用方法、快捷键等信息。

## 2. 源代码结构 (src/)

### 入口文件

#### src/index.js - 应用入口
```javascript
// 主要职责：
// 1. 创建G6图形实例
// 2. 注册自定义节点类型  
// 3. 初始化各个功能模块
// 4. 绑定事件处理器
// 5. 执行初始渲染

import G6 from '@antv/g6';
import { graphConfig } from './config';
// ... 其他导入

const graph = new G6.Graph(graphConfig);
// 初始化流程...
```

#### src/config.js - 全局配置
```javascript
// 配置内容：
// - nodeStateStyles: 节点状态样式
// - defaultNode: 默认节点配置
// - defaultEdge: 默认边配置  
// - graphConfig: G6图实例配置
// - colors: 颜色常量
// - sizes: 尺寸常量
// - styleConfig: 样式常量
```

## 3. 功能模块详解

### components/ - React组件模块

#### ImagePreview.jsx
```javascript
// 图片全屏预览组件
// 功能：
// - 全屏显示图片
// - 鼠标滚轮缩放 (0.1x - 5x)
// - 拖拽移动图片
// - 点击背景关闭
// - 显示缩放百分比

export const showImagePreview = (imgSrc) => {
  // 动态挂载React组件到DOM
};
```

**特点**:
- 使用React Hooks管理状态
- 动态挂载和卸载组件
- 禁用页面滚动防止冲突
- 支持ESC键和点击关闭

### events/ - 事件处理模块

```
events/
├── index.js           # 统一导出所有事件处理函数
├── canvasEvents.js    # 画布事件：点击、键盘、视图变化
├── nodeEvents.js      # 节点事件：点击、双击、右键、拖拽
├── edgeEvents.js      # 边事件：选择处理
├── pasteEvents.js     # 粘贴事件：图片粘贴处理
├── resizeEvents.js    # 调整大小：窗口和节点尺寸
└── utils.js           # 工具函数：选择状态管理
```

**事件分类**:
- **用户交互事件**: 鼠标点击、键盘输入、拖拽操作
- **系统事件**: 窗口调整、视图变化、状态同步
- **自定义事件**: 模块间通信、业务逻辑触发

### nodes/ - 自定义节点模块

```
nodes/
├── index.js           # 导出所有节点注册函数
├── rectangleNode.js   # 矩形节点：支持子图、双线边框
├── textNode.js        # 文本节点：纯文本显示、透明背景
└── imageNode.js       # 图片节点：图片显示、四角控制点
```

**节点实现模式**:
每个节点文件都包含：
- `draw(cfg, group)`: 绘制节点图形
- `update(cfg, node)`: 更新节点属性
- `setState(name, value, node)`: 处理状态变化

### io/ - 文件管理模块

```
io/
├── index.js          # 导出FileManager类
└── fileManager.js    # 文件保存/加载、状态跟踪
```

**核心功能**:
- **现代API支持**: File System Access API
- **兼容性处理**: 自动回退到下载模式
- **完整数据**: 递归保存所有子图数据
- **状态跟踪**: 实时监听修改并更新状态

### toolbar/ - 工具栏模块

```
toolbar/
├── index.js          # 导出工具栏相关类
├── toolbar.js        # 工具栏主类：事件处理、状态管理
└── buttons.js        # 按钮创建：DOM元素生成
```

**工具栏功能**:
- **模式管理**: 添加节点、连线、默认模式切换
- **快捷键**: 完整的键盘快捷键支持
- **状态同步**: 按钮激活状态与当前模式同步
- **文件操作**: 保存、加载功能集成

### navigation/ - 导航系统模块

```
navigation/
├── index.js          # 导出导航相关类
├── navigation.js     # 导航主类：子图管理、路径显示
└── backButton.js     # 返回按钮：UI创建和事件处理
```

**导航特性**:
- **层级管理**: 图层级栈管理无限嵌套
- **路径显示**: 底部导航栏显示完整路径
- **快速跳转**: 点击路径任意层级直接跳转
- **状态保持**: 各层级状态完整保存和恢复

### contextMenu/ - 右键菜单模块

```
contextMenu/
├── index.js          # 导出菜单相关函数
├── contextMenu.js    # 右键菜单：菜单创建、事件处理
└── labelEditor.js    # 文本编辑器：原地编辑功能
```

**菜单功能**:
- **多级菜单**: 主菜单和子菜单结构
- **样式调整**: 字体大小、颜色修改
- **状态显示**: 当前样式高亮显示
- **原地编辑**: 在节点位置直接编辑文本

### styles/ - 样式模块

#### index.css
```css
/* 样式组织：
 * - 容器样式：#container
 * - 工具栏样式：.toolbar, 按钮状态
 * - 上下文菜单：.context-menu, 子菜单
 * - 导航栏：#navigation-bar, 路径显示
 * - 状态栏：.status-bar, 保存状态
 * - 编辑器：.node-editor, 输入框样式
 * - 响应式：悬停效果、过渡动画
 */
```

**样式特点**:
- **模块化**: 按功能模块组织样式
- **响应式**: 支持悬停、激活等交互状态
- **主题统一**: 使用一致的颜色和尺寸规范
- **兼容性**: 支持主流浏览器的CSS特性

## 4. 模块依赖关系

### 依赖层级图
```
index.js (应用入口)
├── config.js (配置)
├── G6 (图形引擎)
├── nodes/ (节点类型)
│   ├── rectangleNode.js
│   ├── textNode.js  
│   └── imageNode.js
├── events/ (事件处理)
│   ├── canvasEvents.js
│   ├── nodeEvents.js
│   ├── edgeEvents.js
│   ├── pasteEvents.js
│   └── resizeEvents.js
├── components/ (React组件)
│   └── ImagePreview.jsx
└── 功能模块
    ├── navigation/ (导航系统)
    ├── contextMenu/ (右键菜单)
    ├── toolbar/ (工具栏)
    └── io/ (文件管理)
```

### 模块间通信

#### 1. 直接依赖
- FileManager → Navigation (获取图数据)
- Toolbar → Graph (模式控制)
- ContextMenu → LabelEditor (文本编辑)

#### 2. 事件通信
```javascript
// 发送事件
graph.emit('saveGraph');
graph.emit('enterSubgraph', node);

// 监听事件  
graph.on('modeChange', callback);
graph.on('node:dblclick', callback);
```

#### 3. 状态共享
```javascript
// 全局状态存储在graph实例中
graph.set('currentMode', 'addNode');
graph.set('selectedItem', node);
graph.get('contextMenu');
```

## 5. 文件命名规范

### 目录命名
- **小写单词**: 如 `components`, `events`
- **复数形式**: 包含多个同类文件的目录使用复数
- **功能导向**: 目录名体现功能模块

### 文件命名  
- **camelCase**: JavaScript文件使用驼峰命名
- **功能描述**: 文件名清晰描述其功能
- **模块导出**: index.js作为模块统一导出入口

### 类和函数命名
- **PascalCase**: 类名使用帕斯卡命名法
- **camelCase**: 函数和变量使用驼峰命名法
- **语义化**: 名称清晰表达功能和用途

## 6. 代码组织原则

### 模块化设计
- **单一职责**: 每个模块专注一个功能领域
- **低耦合**: 模块间依赖最小化
- **高内聚**: 模块内部功能紧密相关

### 文件组织
- **功能分组**: 相关功能文件放在同一目录
- **层次清晰**: 目录结构反映功能层次
- **易于维护**: 便于查找和修改代码

### 导入导出
- **统一入口**: 使用index.js统一导出
- **按需导入**: 只导入需要的功能
- **命名导出**: 使用具名导出提高可读性

## 7. 扩展指南

## 8. 搜索模块详解 (src/search/)

### 模块结构
```
src/search/
├── index.js           # 模块导出文件
├── nodeSearch.js      # 主搜索类实现
└── searchEvents.js    # 搜索事件绑定
```

### 文件说明

#### index.js
```javascript
// 统一导出搜索相关功能
export { NodeSearch } from './nodeSearch';
export { bindSearchEvents } from './searchEvents';
```

#### nodeSearch.js
- **NodeSearch类**: 核心搜索功能实现
- **搜索对话框**: 创建和管理搜索界面
- **节点收集**: 递归收集所有层级的节点
- **跨层级导航**: 精确的路径导航机制
- **节点居中**: 智能的节点定位和居中

#### searchEvents.js
- **快捷键绑定**: Ctrl+F 触发搜索
- **事件处理**: 键盘导航和交互事件

### 搜索模块特性

#### 核心功能
- **实时搜索**: 输入时立即显示匹配结果
- **跨层级搜索**: 可以搜索任意子图中的节点
- **路径显示**: 每个结果显示完整的层级路径
- **智能导航**: 自动导航到目标节点所在位置
- **节点居中**: 使用G6的focusItem API实现平滑居中

#### 技术实现
- **数据同步**: 确保搜索使用最新的图形数据
- **状态管理**: 与现有选择机制完全兼容
- **错误处理**: 完善的错误处理和回退机制
- **调试支持**: 详细的调试输出和状态验证

### 添加新节点类型
1. 在 `src/nodes/` 创建新节点文件
2. 实现 draw、update、setState 方法
3. 在 `src/nodes/index.js` 中导出
4. 在 `src/index.js` 中注册

### 添加新功能模块
1. 创建模块目录和文件
2. 实现模块类和功能函数
3. 在应用入口中初始化模块
4. 添加必要的事件绑定和样式

### 修改样式主题
1. 更新 `src/config.js` 中的颜色配置
2. 修改 `src/styles/index.css` 样式
3. 确保所有组件使用统一的配色方案

### 集成新的第三方库
1. 安装依赖包
2. 在需要的模块中导入
3. 更新构建配置（如需要）
4. 测试兼容性和性能影响


