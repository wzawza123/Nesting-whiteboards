# 工具栏和文件管理系统

## 系统概述

工具栏和文件管理系统提供了完整的用户交互界面和数据持久化功能。工具栏包含所有常用操作按钮，文件管理系统支持现代浏览器的 File System Access API，并提供实时的保存状态跟踪。

## 1. 工具栏系统 (toolbar/)

### Toolbar 类 (toolbar.js)

#### 核心属性
```javascript
class Toolbar {
  constructor(graph) {
    this.graph = graph;
    this.toolbar = createToolbarButtons();  // 创建工具栏DOM
    document.body.appendChild(this.toolbar);
    this.bindEvents();                      // 绑定事件
  }
}
```

#### 工具按钮列表
| 按钮 | ID | 快捷键 | 功能 | 模式 |
|------|----|----|------|------|
| Add Rectangle | addRect | R | 添加矩形节点 | addNode |
| Add Text | addText | T | 添加文本节点 | addText |
| Add Arrow | addEdge | L | 添加连接线 | addEdge |
| Delete Selected | delete | Delete | 删除选中元素 | - |
| Save | saveGraph | Ctrl+S | 保存图形数据 | - |
| Load | loadGraph | Ctrl+O | 加载图形数据 | - |

#### 模式管理

##### 工具模式切换
```javascript
toggleToolMode(mode) {
  const currentMode = this.graph.get('currentMode');
  const newMode = currentMode === mode ? 'default' : mode;
  this.graph.set('currentMode', newMode);
  
  // 如果切换到默认模式，清除边起始节点
  if (newMode === 'default') {
    const edgeStartNode = this.graph.get('edgeStartNode');
    if (edgeStartNode) {
      this.graph.setItemState(edgeStartNode, 'selected', false);
      this.graph.set('edgeStartNode', null);
    }
  }
  
  this.updateButtonState(newMode);
}
```

##### 按钮状态更新
```javascript
updateButtonState(activeMode) {
  // 清除所有按钮的激活状态
  const buttons = ['addRect', 'addText', 'addEdge'];
  buttons.forEach(id => {
    const button = document.getElementById(id);
    if (button) {
      button.classList.remove('active');
    }
  });

  // 设置当前激活按钮的状态
  switch (activeMode) {
    case 'addNode':
      document.getElementById('addRect')?.classList.add('active');
      break;
    case 'addText':
      document.getElementById('addText')?.classList.add('active');
      break;
    case 'addEdge':
      document.getElementById('addEdge')?.classList.add('active');
      break;
  }
}
```

#### 核心功能方法

##### 删除选中元素
```javascript
deleteSelectedItem() {
  const selectedItem = this.graph.get('selectedItem');
  if (selectedItem) {
    this.graph.removeItem(selectedItem);
    this.graph.set('selectedItem', null);
  }
}
```

##### 清除所有选择
```javascript
clearAllSelections() {
  // 清除当前选中的元素
  const selectedItem = this.graph.get('selectedItem');
  if (selectedItem) {
    this.graph.setItemState(selectedItem, 'selected', false);
    this.graph.set('selectedItem', null);
  }

  // 清除边起始节点
  const edgeStartNode = this.graph.get('edgeStartNode');
  if (edgeStartNode) {
    this.graph.setItemState(edgeStartNode, 'selected', false);
    this.graph.set('edgeStartNode', null);
  }

  // 重置工具模式
  const currentMode = this.graph.get('currentMode');
  if (currentMode !== 'default') {
    this.graph.set('currentMode', 'default');
    this.updateButtonState('default');
  }
}
```

### 按钮创建 (buttons.js)

#### createToolbarButtons 函数
```javascript
export const createToolbarButtons = () => {
  const toolbar = document.createElement('div');
  toolbar.className = 'toolbar';
  
  // 添加矩形按钮
  const addRectBtn = document.createElement('button');
  addRectBtn.id = 'addRect';
  addRectBtn.innerHTML = 'Add Rectangle <span class="shortcut">R</span>';
  toolbar.appendChild(addRectBtn);
  
  // 添加文本按钮
  const addTextBtn = document.createElement('button');
  addTextBtn.id = 'addText';
  addTextBtn.innerHTML = 'Add Text <span class="shortcut">T</span>';
  toolbar.appendChild(addTextBtn);
  
  // ... 其他按钮
  
  // 添加分隔符
  const separator = document.createElement('div');
  separator.className = 'separator';
  toolbar.appendChild(separator);
  
  // 添加隐藏的文件输入框
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.id = 'loadFile';
  fileInput.style.display = 'none';
  fileInput.accept = '.json';
  toolbar.appendChild(fileInput);
  
  return toolbar;
};
```

### 快捷键支持

#### 键盘事件绑定
```javascript
document.addEventListener('keydown', (e) => {
  // 忽略输入框中的快捷键
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }

  // 处理快捷键
  switch (e.key) {
    case 'r':
    case 'R':
      e.preventDefault();
      this.toggleToolMode('addNode');
      break;
    case 't':
    case 'T':
      e.preventDefault();
      this.toggleToolMode('addText');
      break;
    case 'l':
    case 'L':
      e.preventDefault();
      this.toggleToolMode('addEdge');
      break;
    case 'Delete':
      e.preventDefault();
      this.deleteSelectedItem();
      break;
    case 's':
    case 'S':
      if (e.ctrlKey) {
        e.preventDefault();
        this.graph.emit('saveGraph');
      }
      break;
    case 'o':
    case 'O':
      if (e.ctrlKey) {
        e.preventDefault();
        document.getElementById('loadFile').click();
      }
      break;
    case 'Escape':
      e.preventDefault();
      this.clearAllSelections();
      break;
  }
});
```

## 2. 文件管理系统 (io/fileManager.js)

### FileManager 类

#### 核心属性
```javascript
class FileManager {
  constructor(graph, navigation) {
    this.graph = graph;
    this.navigation = navigation;
    this.currentFilePath = null;      // 当前文件路径
    this.currentFileHandle = null;    // File System Access API 文件句柄
    this.isSaved = false;             // 保存状态跟踪
    this.bindEvents();
    this.bindModificationEvents();
    this.updateStatusBar(false);
  }
}
```

### 保存功能

#### saveGraph() - 主保存方法
```javascript
async saveGraph() {
  // 更新当前图形状态
  this.navigation.updateCurrentGraphData();
  
  // 获取完整数据（包括所有子图）
  const completeData = {
    currentGraph: this.getCompleteGraphData(this.navigation.currentGraphData),
    graphStack: this.navigation.graphStack.map(graph => this.getCompleteGraphData(graph))
  };
  
  // 转换为JSON并创建blob
  const jsonString = JSON.stringify(completeData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  
  // 检查是否支持 File System Access API
  if ('showSaveFilePicker' in window && this.currentFileHandle) {
    // 使用现代API直接覆盖现有文件
    try {
      const writable = await this.currentFileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      this.updateSaveStatus(true);
    } catch (error) {
      // 失败时回退到下载方式
      this.saveAs(blob, this.currentFileHandle.name);
    }
  } else if ('showSaveFilePicker' in window) {
    // 首次保存，让用户选择保存位置
    try {
      const fileHandle = await window.showSaveFilePicker({
        suggestedName: 'graph-data.json',
        types: [{
          description: 'JSON files',
          accept: { 'application/json': ['.json'] }
        }]
      });
      this.currentFileHandle = fileHandle;
      // 执行保存...
    } catch (error) {
      if (error.name !== 'AbortError') {
        this.saveAs(blob);
      }
    }
  } else {
    // 不支持现代API，使用传统下载方式
    this.saveAs(blob, this.currentFilePath || 'graph-data.json');
  }
}
```

#### getCompleteGraphData() - 递归获取完整数据
```javascript
getCompleteGraphData(graphData) {
  const nodes = graphData.nodes.map(node => {
    const newNode = { ...node };
    if (newNode.subGraph) {
      // 递归处理子图数据
      newNode.subGraph = this.getCompleteGraphData(newNode.subGraph);
    }
    return newNode;
  });
  
  return {
    ...graphData,
    nodes,
    edges: graphData.edges.map(edge => ({ ...edge }))
  };
}
```

#### saveAs() - 传统下载方式
```javascript
saveAs(blob, suggestedName = 'graph-data.json') {
  // 创建下载链接并触发下载
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = suggestedName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  this.currentFilePath = suggestedName;
  this.updateSaveStatus(true);
}
```

### 加载功能

#### loadGraph() - 加载图形数据
```javascript
loadGraph(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const loadedData = JSON.parse(e.target.result);
      
      // 恢复完整数据结构
      this.navigation.currentGraphData = this.restoreGraphData(loadedData.currentGraph);
      this.navigation.graphStack = loadedData.graphStack.map(graph => this.restoreGraphData(graph));
      
      // 更新图形显示
      this.graph.data(this.navigation.currentGraphData);
      this.graph.render();
      
      // 更新导航
      this.navigation.updatePath();
      this.navigation.backButton.update();
      
      // 记录加载的文件信息
      this.currentFilePath = file.name;
      this.currentFileHandle = null;
      this.updateSaveStatus(true);
      
    } catch (error) {
      console.error('Error loading graph data:', error);
      alert('Error loading graph data. Please check if the file is valid.');
    }
  };
  reader.readAsText(file);
}
```

#### restoreGraphData() - 递归恢复数据
```javascript
restoreGraphData(data) {
  // 恢复节点及其子图
  const nodes = data.nodes.map(node => {
    const newNode = { ...node };
    if (newNode.subGraph) {
      newNode.subGraph = this.restoreGraphData(newNode.subGraph);
    }
    return newNode;
  });

  return {
    ...data,
    nodes,
    edges: data.edges.map(edge => ({ ...edge }))
  };
}
```

### 状态管理

#### 保存状态跟踪
```javascript
updateSaveStatus(isSaved) {
  this.isSaved = isSaved;
  this.updateStatusBar(isSaved);
}

markAsModified() {
  if (this.isSaved) {
    this.isSaved = false;
    this.updateStatusBar(false);
  }
}
```

#### 修改事件监听
```javascript
bindModificationEvents() {
  // 节点添加事件
  this.graph.on('afteradditem', (e) => {
    if (e.item && (e.item.getType() === 'node' || e.item.getType() === 'edge')) {
      this.markAsModified();
    }
  });

  // 节点删除事件
  this.graph.on('afterremoveitem', (e) => {
    if (e.item && (e.item.getType() === 'node' || e.item.getType() === 'edge')) {
      this.markAsModified();
    }
  });

  // 节点更新事件
  this.graph.on('afterupdateitem', (e) => {
    if (e.item && (e.item.getType() === 'node' || e.item.getType() === 'edge')) {
      this.markAsModified();
    }
  });

  // 节点拖拽结束事件
  this.graph.on('node:dragend', () => {
    this.markAsModified();
  });

  // 监听画布变化
  this.graph.on('graphstatechange', () => {
    this.markAsModified();
  });
}
```

### 状态栏系统

#### updateStatusBar() - 更新状态显示
```javascript
updateStatusBar(isSaved) {
  let statusBar = document.getElementById('status-bar');
  
  // 如果状态栏不存在，创建一个
  if (!statusBar) {
    statusBar = document.createElement('div');
    statusBar.id = 'status-bar';
    statusBar.className = 'status-bar';
    document.body.appendChild(statusBar);
  }

  if (isSaved && (this.currentFileHandle || this.currentFilePath)) {
    const fileName = this.currentFileHandle ? this.currentFileHandle.name : this.currentFilePath;
    statusBar.innerHTML = `✓ 已保存到: ${fileName}`;
    statusBar.className = 'status-bar saved';
  } else if (this.currentFileHandle || this.currentFilePath) {
    const fileName = this.currentFileHandle ? this.currentFileHandle.name : this.currentFilePath;
    statusBar.innerHTML = `● ${fileName} - 未保存`;
    statusBar.className = 'status-bar unsaved';
  } else {
    statusBar.innerHTML = '● 新文档 - 未保存';
    statusBar.className = 'status-bar unsaved';
  }
}
```

#### 状态栏样式
- **位置**: 右下角固定显示
- **已保存状态**: 绿色背景，显示 "✓ 已保存到: filename"
- **未保存状态**: 橙色背景，显示 "● filename - 未保存"
- **新文档**: 橙色背景，显示 "● 新文档 - 未保存"

## 3. 事件绑定

### 工具栏事件
```javascript
bindEvents() {
  // 工具按钮事件
  document.getElementById('addRect').addEventListener('click', () => {
    this.toggleToolMode('addNode');
  });
  
  // 文件操作事件
  document.getElementById('saveGraph').addEventListener('click', async () => {
    this.graph.emit('saveGraph');
  });
  
  document.getElementById('loadFile').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      this.graph.emit('loadGraph', file);
      event.target.value = '';
    }
  });
  
  // 模式变化监听
  this.graph.on('modeChange', (mode) => {
    this.updateButtonState(mode);
  });
}
```

### 文件管理事件
```javascript
bindEvents() {
  // 保存图形事件
  this.graph.on('saveGraph', async () => {
    await this.saveGraph();
  });

  // 加载图形事件
  this.graph.on('loadGraph', (file) => {
    this.loadGraph(file);
  });
}
```

## 4. 数据格式

### 保存的JSON结构
```javascript
{
  "currentGraph": {
    "id": "root",
    "nodes": [
      {
        "id": "node-1",
        "type": "rectangle-node",
        "label": "Node 1",
        "subGraph": {
          "id": "subgraph-node-1",
          "nodes": [...],
          "edges": [...],
          "parentNode": "node-1"
        }
      }
    ],
    "edges": [...],
    "parentNode": null,
    "label": "Root"
  },
  "graphStack": [...]
}
```

### 特点
- **完整性**: 包含所有层级的完整数据
- **递归结构**: 子图数据递归嵌套在节点中
- **状态保持**: 保存当前层级和栈状态
- **版本兼容**: JSON格式便于扩展和兼容


