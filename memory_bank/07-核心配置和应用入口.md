# 核心配置和应用入口

## 系统概述

核心配置和应用入口是整个项目的基础，定义了所有的样式配置、图形配置和应用初始化流程。`config.js` 提供了统一的配置管理，`index.js` 负责应用的启动和模块初始化。

## 1. 核心配置 (config.js)

### 节点状态样式配置

#### nodeStateStyles - 节点状态样式
```javascript
export const nodeStateStyles = {
  selected: {
    stroke: '#1890ff',        // 选中时的边框颜色
    lineWidth: 2,             // 选中时的边框宽度
    shadowColor: '#1890ff',   // 阴影颜色
    shadowBlur: 10,           // 阴影模糊度
  }
};
```

### 默认节点配置

#### defaultNode - 默认节点样式
```javascript
export const defaultNode = {
  type: 'rectangle-node',     // 默认节点类型
  style: {
    fill: '#fff',             // 背景颜色
    stroke: '#333',           // 边框颜色
    radius: 8,                // 圆角半径
    lineWidth: 1.5,           // 边框宽度
  },
  labelCfg: {
    style: {
      fill: '#333',           // 文本颜色
      fontSize: 20,           // 文本大小
      fontFamily: 'Arial',    // 字体
    },
  },
  size: [200, 100],           // 默认尺寸 [宽度, 高度]
};
```

### 默认边配置

#### defaultEdge - 默认边样式
```javascript
export const defaultEdge = {
  type: 'line',               // 边类型
  style: {
    stroke: '#333',           // 线条颜色
    endArrow: true,           // 显示箭头
    lineWidth: 1,             // 线条宽度
  },
  stateStyles: {
    selected: {
      stroke: '#1890ff',      // 选中时颜色
      lineWidth: 2,           // 选中时宽度
      shadowColor: '#1890ff', // 阴影颜色
      shadowBlur: 10,         // 阴影模糊度
    },
  },
};
```

### 图形配置

#### graphConfig - G6图实例配置
```javascript
export const graphConfig = {
  container: 'container',     // DOM容器ID
  width: window.innerWidth,   // 画布宽度
  height: window.innerHeight, // 画布高度
  modes: {
    default: [
      'drag-canvas',          // 启用画布拖拽
      'zoom-canvas',          // 启用缩放
      'drag-node',            // 启用节点拖拽
      'image-preview',        // 启用图片预览
    ],
  },
  nodeStateStyles,            // 节点状态样式
  defaultNode,                // 默认节点配置
  defaultEdge,                // 默认边配置
};
```

#### 交互模式说明
- **drag-canvas**: 允许拖拽画布移动视图
- **zoom-canvas**: 允许鼠标滚轮缩放画布
- **drag-node**: 允许拖拽节点改变位置
- **image-preview**: 自定义的图片预览交互模式

### 颜色配置

#### colors - 颜色常量
```javascript
export const colors = {
  primary: '#1890ff',         // 主色调（蓝色）
  success: '#52c41a',         // 成功色（绿色）
  warning: '#faad14',         // 警告色（黄色）
  error: '#f5222d',           // 错误色（红色）
  purple: '#722ed1',          // 紫色
  black: '#333333',           // 黑色
};
```

#### 颜色使用场景
- **primary**: 选中状态、主要按钮、链接
- **success**: 保存成功状态
- **warning**: 未保存状态
- **error**: 错误提示、删除操作
- **purple**: 文本颜色选项之一
- **black**: 默认文本颜色

### 尺寸配置

#### sizes - 尺寸常量
```javascript
export const sizes = {
  controlPoint: 10,           // 控制点大小
  minNodeSize: 50,            // 最小节点尺寸
  maxImageSize: 250,          // 最大图片尺寸
  padding: {
    small: 6,                 // 小间距
    medium: 12,               // 中等间距
    large: 24,                // 大间距
  },
};
```

#### 尺寸应用
- **controlPoint**: 图片节点四角调整控制点的大小
- **minNodeSize**: 节点调整大小时的最小限制
- **maxImageSize**: 粘贴图片时的最大尺寸限制
- **padding**: 各种UI元素的内边距

### 样式配置

#### styleConfig - 样式常量
```javascript
export const styleConfig = {
  shadowColor: '#1890ff',     // 默认阴影颜色
  shadowBlur: 10,             // 默认阴影模糊度
  borderRadius: 4,            // 默认圆角半径
  fontSize: {
    small: 16,                // 小字体
    medium: 20,               // 中等字体
    large: 24,                // 大字体
    extraLarge: 28,           // 超大字体
  },
};
```

## 2. 应用入口 (index.js)

### 导入依赖
```javascript
import G6 from '@antv/g6';
import { graphConfig } from './config';
import { registerImageNode, registerTextNode, registerRectangleNode } from './nodes';
import { bindNodeEvents, bindEdgeEvents, bindCanvasEvents, bindResizeEvents, bindPasteEvents } from './events';
import { Toolbar } from './toolbar';
import { ContextMenu } from './contextMenu';
import { Navigation } from './navigation';
import { FileManager } from './io';
import './styles/index.css';
```

### 初始化流程

#### 1. 创建G6图实例
```javascript
// 初始化图形实例
const graph = new G6.Graph(graphConfig);

// 设置初始模式
graph.set('currentMode', 'default');
```

#### 2. 注册自定义节点类型
```javascript
// 注册自定义节点
registerImageNode(G6);
registerTextNode(G6);
registerRectangleNode(G6);
```

**注册顺序说明**:
- 先注册图片节点（image-node）
- 再注册文本节点（text-only）
- 最后注册矩形节点（rectangle-node，默认类型）

#### 3. 初始化各个模块
```javascript
// 初始化各个模块
const navigation = new Navigation(graph);
const contextMenu = new ContextMenu(graph);
const toolbar = new Toolbar(graph);
const fileManager = new FileManager(graph, navigation);

// 将上下文菜单实例保存到图形实例中
graph.set('contextMenu', contextMenu);
```

**模块初始化顺序**:
1. **Navigation**: 导航系统，管理图层级
2. **ContextMenu**: 右键菜单系统
3. **Toolbar**: 工具栏系统
4. **FileManager**: 文件管理系统

#### 4. 绑定事件处理器
```javascript
// 绑定事件
bindNodeEvents(graph);
bindEdgeEvents(graph);
bindCanvasEvents(graph);
bindResizeEvents(graph);
bindPasteEvents(graph);
```

**事件绑定顺序**:
1. **节点事件**: 点击、双击、右键等
2. **边事件**: 边的选择处理
3. **画布事件**: 画布点击、键盘快捷键
4. **调整大小事件**: 窗口和节点尺寸调整
5. **粘贴事件**: 图片粘贴处理

#### 5. 初始化渲染
```javascript
// 初始化渲染
graph.data(navigation.currentGraphData);
graph.render();
```

### 模块依赖关系

#### 依赖关系图
```
G6.Graph (核心实例)
├── Navigation (图层级管理)
│   ├── BackButton (返回按钮)
│   └── currentGraphData (当前图数据)
├── ContextMenu (右键菜单)
├── Toolbar (工具栏)
└── FileManager (文件管理)
    └── Navigation (依赖导航获取数据)
```

#### 模块间通信

##### 1. 通过Graph实例通信
```javascript
// 存储模块实例到graph
graph.set('contextMenu', contextMenu);

// 在其他模块中获取
const contextMenu = graph.get('contextMenu');
```

##### 2. 通过事件系统通信
```javascript
// 发送事件
graph.emit('saveGraph');
graph.emit('loadGraph', file);
graph.emit('enterSubgraph', node);

// 监听事件
graph.on('saveGraph', () => { /* 处理保存 */ });
graph.on('modeChange', (mode) => { /* 更新UI状态 */ });
```

##### 3. 通过状态管理通信
```javascript
// 设置全局状态
graph.set('currentMode', 'addNode');
graph.set('selectedItem', node);
graph.set('mousePosition', point);

// 获取全局状态
const currentMode = graph.get('currentMode');
const selectedItem = graph.get('selectedItem');
```

### 全局状态管理

#### 图实例中存储的状态
```javascript
{
  currentMode: 'default',           // 当前工具模式
  selectedItem: node,               // 当前选中的元素
  edgeStartNode: node,              // 连线起始节点
  mousePosition: { x: 100, y: 200 }, // 鼠标位置
  contextMenu: contextMenuInstance,  // 右键菜单实例
}
```

#### 状态管理原则
1. **集中管理**: 所有全局状态都存储在graph实例中
2. **事件驱动**: 状态变化通过事件通知相关模块
3. **模块隔离**: 每个模块只管理自己的内部状态
4. **数据流向**: 单向数据流，避免循环依赖

### 启动检查清单

#### 必要条件
1. ✅ DOM容器存在（id="container"）
2. ✅ G6库正确加载
3. ✅ 所有模块依赖正确导入
4. ✅ 自定义节点类型注册完成
5. ✅ 事件处理器绑定完成
6. ✅ 初始数据设置完成

#### 初始化验证
```javascript
// 验证图实例创建成功
console.log('Graph instance:', graph);

// 验证模块初始化
console.log('Navigation:', navigation);
console.log('ContextMenu:', contextMenu);
console.log('Toolbar:', toolbar);
console.log('FileManager:', fileManager);

// 验证事件绑定
console.log('Event listeners bound');

// 验证初始渲染
console.log('Initial render complete');
```

### 错误处理

#### 常见初始化错误
1. **容器不存在**: 确保HTML中有id="container"的元素
2. **依赖加载失败**: 检查import路径和模块导出
3. **节点注册失败**: 确保G6版本兼容性
4. **事件绑定失败**: 检查事件名称和处理函数

#### 调试建议
1. 打开浏览器开发者工具
2. 检查控制台错误信息
3. 验证DOM元素是否正确创建
4. 测试基础交互功能
5. 检查网络请求和资源加载
