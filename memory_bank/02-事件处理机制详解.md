# 事件处理机制详解

## 事件处理架构概述

项目采用模块化的事件处理架构，每个事件类型都有专门的处理文件。所有事件处理器都通过 `src/events/index.js` 导出，在 `src/index.js` 中统一绑定。

## 1. 画布事件 (canvasEvents.js)

### 主要事件处理

#### canvas:mousemove
- **功能**: 跟踪鼠标位置
- **实现**: 将鼠标位置存储到 `graph.mousePosition`
- **用途**: 为图片粘贴等功能提供位置信息

#### canvas:click
- **功能**: 处理画布点击
- **模式处理**:
  - `addNode` 模式: 在点击位置创建矩形节点
  - `addText` 模式: 在点击位置创建文本节点
  - `default` 模式: 清除选择状态
- **自动化**: 创建节点后自动进入编辑模式

#### viewportchange / dragstart
- **功能**: 视图变化时隐藏上下文菜单
- **触发时机**: 画布缩放、拖拽开始时

### 键盘事件处理

```javascript
document.addEventListener('keydown', (e) => {
  // 忽略输入框中的按键
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    return;
  }

  if (e.key === 'Escape') {
    // 取消当前工具模式
  } else if (e.key === ' ') {
    // 空格键自动适配视图
    fitView(graph);
  }
});
```

### fitView 函数
- **功能**: 自动适配视图
- **参数**: padding [100, 150, 100, 150]
- **限制**: maxZoom: 1.5, minZoom: 0.2

## 2. 节点事件 (nodeEvents.js)

### 主要事件处理

#### node:click
- **连线模式处理**:
  - 第一次点击: 设置起始节点
  - 第二次点击: 创建连接线
- **默认模式**: 更新选择状态

#### node:dblclick
- **图片节点**: 打开全屏预览
- **文本节点**: 进入编辑模式
- **矩形节点**: 进入子图模式

#### node:contextmenu
- **功能**: 显示右键菜单
- **参数**: clientX, clientY, item

#### node:mousedown
- **控制点检测**: 检查是否点击了 `control-point-*` 形状
- **调整大小**: 初始化调整大小状态

### 鼠标事件处理

```javascript
// 全局鼠标移动处理
export const handleMouseMove = (graph, ev) => {
  if (isResizing && resizeNode) {
    // 根据控制点位置计算新尺寸
    // 支持 nw, ne, se, sw 四个方向
  }
};

// 鼠标释放处理
export const handleMouseUp = () => {
  // 重置调整大小状态
};
```

## 3. 边事件 (edgeEvents.js)

### edge:click
- **功能**: 边的选择处理
- **实现**: 调用 `updateSelection(graph, edge)`

## 4. 粘贴事件 (pasteEvents.js)

### document paste 事件
- **检测**: 遍历 `clipboardData.items` 查找图片
- **处理流程**:
  1. 读取图片文件
  2. 创建临时 Image 对象获取尺寸
  3. 按比例缩放到合适大小
  4. 在鼠标位置创建图片节点

```javascript
// 尺寸计算逻辑
const maxSize = sizes.maxImageSize;
if (width > height) {
  if (width > maxSize) {
    height *= maxSize / width;
    width = maxSize;
  }
} else {
  if (height > maxSize) {
    width *= maxSize / height;
    height = maxSize;
  }
}
```

## 5. 调整大小事件 (resizeEvents.js)

### 窗口调整大小
```javascript
window.addEventListener('resize', () => {
  graph.changeSize(window.innerWidth, window.innerHeight);
});
```

### 节点调整大小
- **控制点**: nw, ne, se, sw 四个角
- **约束**: 最小尺寸限制
- **实时更新**: 鼠标移动时实时更新节点大小

## 6. 工具函数 (utils.js)

### updateSelection 函数
```javascript
export const updateSelection = (graph, item) => {
  // 清除之前的选择
  const selectedItem = graph.get('selectedItem');
  if (selectedItem) {
    graph.setItemState(selectedItem, 'selected', false);
  }
  
  // 设置新的选择
  if (item) {
    graph.setItemState(item, 'selected', true);
  }
  
  // 更新图的选中项状态
  graph.set('selectedItem', item);
};
```

## 事件绑定流程

在 `src/index.js` 中的绑定顺序:
```javascript
// 绑定事件
bindNodeEvents(graph);
bindEdgeEvents(graph);
bindCanvasEvents(graph);
bindResizeEvents(graph);
bindPasteEvents(graph);
```

## 事件通信机制

- **G6内置事件**: 如 node:click, canvas:click 等
- **自定义事件**: 如 enterSubgraph, saveGraph, loadGraph 等
- **状态管理**: 通过 graph.set() 和 graph.get() 管理全局状态
- **模块通信**: 事件系统连接各模块，实现解耦


